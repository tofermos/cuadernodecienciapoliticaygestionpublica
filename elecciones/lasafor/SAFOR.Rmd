---
title: "EL VOTO AUTONÓMICO EN LA COMARCA DE LA SAFOR (VALENCIA)"
author: "Tomàs Ferrandis Moscardó"
date: "2024-01-26"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    df_print: paged
    number_sections: false
  pdf_document:
    latex_engine: pdflatex
    toc: true
    keep_tex: true
---
# EJEMPLO DE USO DE RMARDOWN

## DESCRIPCIÓN
A continuación veremos un sencillo ejemplo de uso de R Markdown en el que, a partir de un fichero *csv* con resultados electorales, crearemos y manipularemos objetos _data.frame_ para obtener algunas medidas de *tendencia central y dispersión* que representaremos en tablas y gráficos.

### Inclusión de los paquetes ( y sus librerías) que vamos a necesitar.

```{r 0, include=FALSE}
# Requisitos previes. Paquetes y librerías
knitr::opts_chunk$set(echo = TRUE)
if (!require("dplyr")) {
install.packages("dplyr")}
if (!require("stringr")) {
install.packages("stringr")
}
if (!require("curl")) {
install.packages("curl")
}
if (!require("rsconnect")){
install.packages("rsconnect")
}

require(data.table)
require(knitr)
library(stringr)
library(dplyr)
library(ggplot2)
if (!require("kableExtra")){
install.packages("kableExtra")}

if (!require("tidyverse")){
install.packages("tidyverse")}


```


## OBTENCIÓN DE LOS DATOS

### Resultados de todas las elecciones y convocatorias a nivel de agregación comarcal. Caso de La Safor.

A partir de la base de datos de ARGOS descargamos el resumen de resultados electorales en las distintas convocatorias y procesos electorales en un fichero CSV.

  ```{r 1, include=TRUE}
  df1<-read.csv("CSV/SAFOR.csv",header=TRUE, sep=",",quote="\"'", dec=",",fill=TRUE,
                comment.char = "")
  #View(df1) # Para ver en consola
  ```

### Filtramos por elecciones autonómicas.

Asumimos como universo o población el conjunto de todas las elecciones autonómicas.

```{r 2, include=TRUE}
df_autonomicas<-df1 %>% filter(str_detect(df1$Elecció,"A-"))
# Vemos las 10 primeras lineas de ejemplo
head(df_autonomicas)
```

### Tratamiento de los NA

En nuestro caso los NA se deben a la ausencia de resultados por no haberse presentado la fuerza política en una conveocatoria o haberse integrado en una coalición electoral. Entendemos que el valor que debe sustituir NA para poder realizar cálculos estadísticos de forma correcta y sin errores de computación es el 0. Podríamos recorrer solo las columnas de partidos pero lo simplificamos y aplicamos la sustitución NA -\> 0 en todo el data frame.

```{r 3, include=TRUE}
df_autonomicas[is.na(df_autonomicas)]<-0
knitr::kable(df_autonomicas, caption = "ELECCIONES AUTONÓMICAS EN LA SAFOR")

```

## Creamos un vector con las candidaturas.

```{r 4, include=TRUE}
# Recogemos los nombres de columnas a partir de la 4ª
partits<-names(df1[4:length(df1)])

# O directamente, para nuestro caso
#partits<-c("PP","PSPV","COMPROMÍS","VOX","PODEMOS","Cs","EUPV","RESTA")

```

## Calculamos algunos valores de medidas tendencia central y dispersión

1.- Media o promedio
2.- Máximos
3.- Míninos
4.- Rango de variación

```{r 5, include=TRUE}
mitjana<-summarise_at(df_autonomicas,partits,mean)
maxims<-summarise_at(df_autonomicas,partits,max)
minims<-summarise_at(df_autonomicas,partits,~min(.[. != 0])) #Descartamos los 0
rangodevariacion<-maxims - minims

#Creamos un data frame. cada vector anterior será una columna
df_resultats<-rbind(mitjana)
df_resultats<-rbind(df_resultats,maxims)
df_resultats<-rbind(df_resultats,minims)
df_resultats<-rbind(df_resultats,rangodevariacion)
#Redondeamos los valores a enteros ( son votos) 
df_resultats<-df_resultats %>% mutate_at(partits, as.integer)

#Añadimos al final del data frame una columna con el nombre del "cálculo"
df_resultats<-cbind(df_resultats,ESTADÍSTICA=c("MEDIA","MÁXIMO","MÍNIMO","RANGO"))
# la resituamos en la posición 1 ( estética)
df_resultats<-df_resultats %>% select("ESTADÍSTICA",everything())

#Imprimimos en Markdown una tabla con los resultados
knitr::kable(df_resultats, caption = "ESTADÍSTICA SAFOR")
```

## GRÁFICOS 

Vemos a continuación los gráficos y tablas de daraso a nivel de agregación de candidatura.

```{r 6, results='asis'}
# Recorremos las columnas del data frame correspondientes a candidaturas ( >2)
# Creamos un data frame en cada iteración
for ( i in 2:length(df_resultats)){
     df_estPartit<- data.frame(
         ESTADÍSTICA=df_resultats$ESTADÍSTICA,
         VALORS=df_resultats[,i],
         PARTIT=colnames(df_resultats[i])
     )

# EN UN GRAFICO
barplot(df_estPartit$VALORS, 
        main=paste("Valores estadísticos de",df_estPartit$PARTIT[1]),
        names.arg=df_estPartit$ESTADÍSTICA,
        col=c("#5fe10b","red","#48b7f7","#ede12e"),
        ylab="VOTOS")


# EN UNA TABLA
#Quitamos la columna que repite el nombre ( estético), lo guardamos antes
candidatura<-df_estPartit$PARTIT[1]
df_estPartit <- df_estPartit[, !(names(df_estPartit) %in% "PARTIT")]
knitr::kable(df_estPartit, caption = paste( "ESTADÍSTICA SAFOR", 
                        candidatura )) %>% print()


}


```
